#!/bin/bash

source "$(dirname "${BASH_SOURCE[0]}")/remindy-common"

clear

ICON_YES=" "
ICON_NO=" "

count=$(lock_read | jq '.reminders | length')

if [[ "$count" -eq 0 ]]; then
  msg_warn "No reminders"
  echo ""
  read -n 1 -s -r -p "Press any key to continue..."
  exit 0
fi

day_num_to_name() {
  case "$1" in
    1) echo "Mon" ;; 2) echo "Tue" ;; 3) echo "Wed" ;; 4) echo "Thu" ;;
    5) echo "Fri" ;; 6) echo "Sat" ;; 7) echo "Sun" ;;
  esac
}

lock_read | jq -r '.reminders[] | "\(.id)\t\(.type)\t\(.time)\t\((.days // []) | map(tostring) | join(",") | if . == "" then "-" else . end)\t\((.notified // .last_notified // "-") | if . == "" then "-" else tostring end)\t\(.text)"' | \
while IFS=$'\t' read -r id type time days notified text; do
  case "$type" in
    once)
      day="${time:0:10}"
      hour="${time:11:5}"
      quando=$(date -d "$day" "+%a %d %b %Y $hour")
      ;;
    daily)
      quando="Every day at $time"
      ;;
    weekly)
      day_names=""
      IFS=',' read -ra day_nums <<< "$days"
      for dn in "${day_nums[@]}"; do
        [[ -n "$day_names" ]] && day_names+=","
        day_names+=$(day_num_to_name "$dn")
      done
      quando="Every $day_names at $time"
      ;;
  esac

  case "$type" in
    once)
      if [[ "$notified" == "true" ]]; then
        icon="$ICON_YES"
      else
        icon="$ICON_NO"
      fi
      ;;
    *)
      if [[ "$notified" == "-" || "$notified" == "null" ]]; then
        icon="$ICON_NO"
      else
        icon="$ICON_YES"
      fi
      ;;
  esac

  echo "$icon $text · $type · $quando · $id"
done | gum filter --header "$(banner_header)" --placeholder "Filter reminders..." > /dev/null
