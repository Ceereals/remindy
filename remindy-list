#!/bin/bash

source "$(dirname "${BASH_SOURCE[0]}")/remindy-common"

count=$(lock_read | jq '.reminders | length')

if [[ "$count" -eq 0 ]]; then
  msg_warn "No reminders"
  exit 0
fi

day_num_to_name() {
  case "$1" in
    1) echo "Mon" ;; 2) echo "Tue" ;; 3) echo "Wed" ;; 4) echo "Thu" ;;
    5) echo "Fri" ;; 6) echo "Sat" ;; 7) echo "Sun" ;;
  esac
}

# Build table rows: ID<tab>Type<tab>When<tab>Text
lock_read | jq -r '.reminders[] | "\(.id)\t\(.type)\t\(.time)\t\((.days // []) | map(tostring) | join(",") | if . == "" then "-" else . end)\t\(.notified // .last_notified // "-")\t\(.text)"' | \
while IFS=$'\t' read -r id type time days notified text; do
  case "$type" in
    once)
      day="${time:0:10}"
      hour="${time:11:5}"
      quando=$(date -d "$day" "+%a %d %b %Y $hour")
      ;;
    daily)
      quando="Every day at $time"
      ;;
    weekly)
      day_names=""
      IFS=',' read -ra day_nums <<< "$days"
      for dn in "${day_nums[@]}"; do
        [[ -n "$day_names" ]] && day_names+=","
        day_names+=$(day_num_to_name "$dn")
      done
      quando="Every $day_names at $time"
      ;;
  esac
  # Format notified value with colors
  case "$type" in
    once)
      if [[ "$notified" == "true" ]]; then
        notified_display=$'\e[32mYes\e[0m'
      else
        notified_display=$'\e[33mNo\e[0m'
      fi
      ;;
    *)
      if [[ "$notified" == "-" || "$notified" == "null" ]]; then
        notified_display=$'\e[33m-\e[0m'
      else
        notified_display=$'\e[32m'"$notified"$'\e[0m'
      fi
      ;;
  esac
  printf '%s\t%s\t%s\t%s\t%s\n' "$id" "$type" "$quando" "$notified_display" "$text"
done | gum table --separator $'\t' --columns "ID,Type,When,Notified,Text" --print
