#!/bin/bash
set -eEo pipefail

source "$(dirname "${BASH_SOURCE[0]}")/remindy-common"

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  echo "Usage: $(basename "$0") [ID]"
  echo "  Interactive:  $(basename "$0")"
  echo "  By ID:        $(basename "$0") a1b2c3d4"
  exit 0
fi

clear

data=$(lock_read)
count=$(echo "$data" | jq '.reminders | length')

if [[ "$count" -eq 0 ]]; then
  msg_warn "No reminders to remove"
  exit 0
fi

if [[ $# -eq 0 ]]; then
  # Interactive mode: pick reminders via gum filter --no-limit
  selections=$(format_reminders "$data" "$ICON_YES" "$ICON_NO" | \
    gum filter --header "$(banner_header)" --no-limit --placeholder "Select reminders to remove...")

  [[ -z "$selections" ]] && exit 0

  # Extract IDs (last field after " · ")
  ids=()
  while IFS= read -r line; do
    id="${line##* · }"
    ids+=("$id")
  done <<< "$selections"

  # Confirm before deleting
  sel_count=${#ids[@]}
  if ! gum confirm "Remove $sel_count reminder(s)?"; then
    exit 0
  fi

  # Remove all selected
  for id in "${ids[@]}"; do
    text=$(echo "$data" | jq -r --arg id "$id" '.reminders[] | select(.id == $id) | .text')
    data=$(echo "$data" | jq --arg id "$id" '.reminders |= map(select(.id != $id))')
    msg_ok "Removed: \"$text\" ($id)"
  done
  echo "$data" | lock_write
else
  id="$1"
  match=$(echo "$data" | jq --arg id "$id" '.reminders[] | select(.id == $id)')
  if [[ -z "$match" ]]; then
    msg_err "Reminder not found: $id"
    exit 1
  fi
  text=$(echo "$match" | jq -r '.text')

  if ! gum confirm "Remove \"$text\"?"; then
    exit 0
  fi

  echo "$data" | jq --arg id "$id" '.reminders |= map(select(.id != $id))' | lock_write
  msg_ok "Removed: \"$text\" ($id)"
fi

signal_waybar
