#!/bin/bash

DATA_DIR=~/.local/share/remindy
CONFIG_FILE=~/.config/remindy/config
REMINDERS_FILE="$DATA_DIR/reminders.json"
LOCK_FILE="${XDG_RUNTIME_DIR:-/tmp}/remindy.lock"

mkdir -p "$DATA_DIR/sounds"
mkdir -p ~/.config/remindy
[[ -f "$REMINDERS_FILE" ]] || echo '{"reminders":[]}' > "$REMINDERS_FILE"

# Validate JSON integrity (skip for daemon — it handles jq errors via set -e)
if [[ "$(basename "${BASH_SOURCE[1]:-}")" != "remindy-check" ]]; then
  if ! jq empty "$REMINDERS_FILE" 2>/dev/null; then
    echo "Error: $REMINDERS_FILE is corrupted." >&2
    echo "Check the file manually, or reset with:" >&2
    echo "  echo '{\"reminders\":[]}' > $REMINDERS_FILE" >&2
    exit 1
  fi
fi

# Config defaults
sound=true
sound_file="$DATA_DIR/sounds/remindy.ogg"
notification_timeout=30000
waybar_icon="󰀠"
[[ -f "$CONFIG_FILE" ]] && source "$CONFIG_FILE"

lock_write() {
  local tmp="$REMINDERS_FILE.tmp"
  (
    flock -x -w 5 200 || { echo "Error: could not acquire lock" >&2; return 1; }
    cat > "$tmp"
    mv "$tmp" "$REMINDERS_FILE"
  ) 200>"$LOCK_FILE"
}

lock_read() {
  (
    flock -s -w 5 200 || { echo "Error: could not acquire lock" >&2; return 1; }
    cat "$REMINDERS_FILE"
  ) 200>"$LOCK_FILE"
}

gen_id() {
  if command -v xxd &>/dev/null; then
    head -c 4 /dev/urandom | xxd -p
  else
    head -c 4 /dev/urandom | od -An -tx1 | tr -d ' \n'
  fi
}

day_num_to_name() {
  case "$1" in
    1) echo "Mon" ;; 2) echo "Tue" ;; 3) echo "Wed" ;; 4) echo "Thu" ;;
    5) echo "Fri" ;; 6) echo "Sat" ;; 7) echo "Sun" ;;
  esac
}

# Format reminders as display lines: "icon text · type · schedule · id"
# Usage: format_reminders "$json_data" "$icon_yes" "$icon_no"
format_reminders() {
  local data="$1" icon_yes="$2" icon_no="$3"
  echo "$data" | jq -r '.reminders[] | "\(.id)\t\(.type)\t\(.time)\t\((.days // []) | map(tostring) | join(",") | if . == "" then "-" else . end)\t\((.notified // .last_notified // "-") | if . == "" then "-" else tostring end)\t\(.text)"' | \
  while IFS=$'\t' read -r id type time days notified text; do
    case "$type" in
      once)
        day="${time:0:10}"
        hour="${time:11:5}"
        quando=$(date -d "$day" "+%a %d %b %Y $hour")
        ;;
      daily)
        quando="Every day at $time"
        ;;
      weekly)
        day_names=""
        IFS=',' read -ra day_nums <<< "$days"
        for dn in "${day_nums[@]}"; do
          [[ -n "$day_names" ]] && day_names+=","
          day_names+=$(day_num_to_name "$dn")
        done
        quando="Every $day_names at $time"
        ;;
    esac

    case "$type" in
      once)
        if [[ "$notified" == "true" ]]; then
          icon="$icon_yes"
        else
          icon="$icon_no"
        fi
        ;;
      *)
        if [[ "$notified" == "-" || "$notified" == "null" ]]; then
          icon="$icon_no"
        else
          icon="$icon_yes"
        fi
        ;;
    esac

    echo "$icon $text · $type · $quando · $id"
  done
}

ICON_YES=" "
ICON_NO=" "

valid_time() {
  [[ "$1" =~ ^([0-9]{1,2}):([0-9]{2})$ ]] &&
    (( BASH_REMATCH[1] < 24 && BASH_REMATCH[2] < 60 ))
}

signal_waybar() {
  pkill -RTMIN+9 waybar 2>/dev/null || true
}

# Consistent gum colors
COLOR_SUCCESS=2   # green
COLOR_WARN=3      # yellow
COLOR_ERROR=1     # red
COLOR_ACCENT=212  # pink/magenta accent

msg_ok()   { gum style --foreground "$COLOR_SUCCESS" "✓ $*"; }
msg_warn() { gum style --foreground "$COLOR_WARN" "$*"; }
msg_err()  { gum style --foreground "$COLOR_ERROR" "$*" >&2; }

banner_header() {
  gum style --foreground "$COLOR_ACCENT" --bold "$(banner_text)"
}

banner_text() {
  printf '%s\n' \
    "                                                                        " \
    "                                    ,,                    ,,            " \
    "                                    db                  \`7MM            " \
    "                                                          MM            " \
    "\`7Mb,od8 .gP\"Ya \`7MMpMMMb.pMMMb.  \`7MM  \`7MMpMMMb.   ,M\"\"bMM \`7M'   \`MF'" \
    "  MM' \"',M'   Yb  MM    MM    MM    MM    MM    MM ,AP    MM   VA   ,V  " \
    "  MM    8M\"\"\"\"\"\"  MM    MM    MM    MM    MM    MM 8MI    MM    VA ,V   " \
    "  MM    YM.    ,  MM    MM    MM    MM    MM    MM \`Mb    MM     VVV    " \
    ".JMML.   \`Mbmmd'.JMML  JMML  JMML..JMML..JMML  JMML.\`Wbmd\"MML.   ,V     " \
    "                                                                ,V      " \
    "                                                             OOb\"       "
}

show_banner() {
  gum style --foreground "$COLOR_ACCENT" --bold "$(banner_text)"
}
