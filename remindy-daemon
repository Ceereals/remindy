#!/bin/bash
set -eEo pipefail

SERVICE_NAME="remindy"
SERVICE_DIR="$HOME/.config/systemd/user"
SERVICE_FILE="$SERVICE_DIR/$SERVICE_NAME.service"
TIMER_FILE="$SERVICE_DIR/$SERVICE_NAME.timer"
CHECK_BIN="$HOME/.local/share/omarchy/bin/remindy-check"

action="${1:-}"

case "$action" in
  enable)
    mkdir -p "$SERVICE_DIR"

    cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=Remindy checker

[Service]
Type=oneshot
ExecStart=$CHECK_BIN
Environment=DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/%U/bus
Environment=XDG_RUNTIME_DIR=/run/user/%U
EOF

    cat > "$TIMER_FILE" <<EOF
[Unit]
Description=Remindy timer

[Timer]
OnBootSec=1s
OnUnitActiveSec=1s
AccuracySec=1s

[Install]
WantedBy=timers.target
EOF

    systemctl --user daemon-reload
    systemctl --user enable --now "$SERVICE_NAME.timer"
    echo "Remindy daemon enabled."
    ;;

  disable)
    systemctl --user disable --now "$SERVICE_NAME.timer" 2>/dev/null || true
    rm -f "$SERVICE_FILE" "$TIMER_FILE"
    systemctl --user daemon-reload
    echo "Remindy daemon disabled."
    ;;

  status)
    systemctl --user status "$SERVICE_NAME.timer"
    ;;

  -h|--help)
    echo "Usage: $(basename "$0") enable|disable|status"
    echo "  enable   Create and start the systemd user timer"
    echo "  disable  Stop and remove the systemd user timer"
    echo "  status   Show timer status"
    exit 0
    ;;

  *)
    echo "Usage: $(basename "$0") enable|disable|status"
    exit 1
    ;;
esac
