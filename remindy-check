#!/bin/bash
set -eEo pipefail

source "$(dirname "${BASH_SOURCE[0]}")/remindy-common"

now_datetime=$(date +%Y-%m-%dT%H:%M:%S)
now_date=$(date +%Y-%m-%d)
now_time=$(date +%H:%M)
now_dow=$(date +%u)  # 1=Mon, 7=Sun

data=$(lock_read)
count=$(echo "$data" | jq '.reminders | length')

[[ "$count" -eq 0 ]] && exit 0

# Extract all fields in a single jq call
entries=$(echo "$data" | jq -r '.reminders[] | "\(.id)\t\(.type)\t\(.text)\t\(.time)\t\(if .notified == null then "" else (.notified | tostring) end)\t\(.last_notified // "")\t\((.days // []) | map(tostring) | join(","))"')

changed=false
notify_list=()
remove_ids=()
update_ids=()

while IFS=$'\t' read -r id type text time notified last_notified days; do
  case "$type" in
    once)
      if [[ "$notified" == "false" && ! "$time" > "$now_datetime" ]]; then
        notify_list+=("$text")
        remove_ids+=("$id")
        changed=true
      fi
      ;;
    daily)
      if [[ "$time" == "$now_time" && "$last_notified" != "$now_date" ]]; then
        notify_list+=("$text")
        update_ids+=("$id")
        changed=true
      fi
      ;;
    weekly)
      match=false
      IFS=',' read -ra day_list <<< "$days"
      for d in "${day_list[@]}"; do
        [[ "$d" == "$now_dow" ]] && match=true
      done

      if [[ "$match" == "true" && "$time" == "$now_time" && "$last_notified" != "$now_date" ]]; then
        notify_list+=("$text")
        update_ids+=("$id")
        changed=true
      fi
      ;;
  esac
done <<< "$entries"

# Write back if anything changed — single jq pass for all mutations
if [[ "$changed" == "true" ]]; then
  # Build jq filter: remove once reminders, update last_notified for daily/weekly
  jq_filter="."
  for id in "${remove_ids[@]}"; do
    jq_filter+=" | .reminders |= map(select(.id != \"$id\"))"
  done
  for id in "${update_ids[@]}"; do
    jq_filter+=" | .reminders |= map(if .id == \"$id\" then .last_notified = \"$now_date\" else . end)"
  done

  echo "$data" | jq "$jq_filter" | lock_write
  signal_waybar
fi

# Send notifications
for text in "${notify_list[@]}"; do
  notify-send -u critical -a "Remindy" -i alarm-symbolic -t "$notification_timeout" "⏰ Reminder" "$text"

  if [[ "$sound" == "true" && -f "$sound_file" ]]; then
    paplay "$sound_file"
  fi
done
